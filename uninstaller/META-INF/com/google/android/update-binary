#!/sbin/sh
## Kali NetHunter uninstaller
## TODO:
## - Bootanimation
## - Wallpaper
## - Magisk support (https://github.com/topjohnwu/Magisk/blob/master/scripts/update_binary.sh // https://github.com/topjohnwu/Magisk/blob/master/scripts/uninstaller.sh)

print() {
  echo "${1:- }" \
    | while read -r line; do
       echo -e "ui_print $line" > "$console"
       echo -e "ui_print \n" > "$console"
    done
}

abort() {
  [ "$1" ] && {
    print "! Error: $1"
    print "* Aborting"
  }
  cleanup
  print "* Failed to uninstall Kali NetHunter!"
  exit 1
}

cleanup() {
  rm -f /system_root/.rw
  rm -f /system/.rw
  rm -f /data/.rw

  umount /system_root
  umount /system

  [ "$ZIPFILE" ] && {
   rm -f /tmp/console
  }
}

mount() {
  mountpoint -q "$1" || /sbin/busybox mount -o rw "$1" || abort "Unable to mount $1 as rw!"
  >> "$1/.rw" && return || /sbin/busybox mount -o remount,rw "$1" || abort "Unable to write to $1!"
}

remove_app() {
  [ -d "${1}" ] && {
    print "* Removing ${2} (${3})"
    rm -rf "${1}"
  }
}

if [ "$3" ]; then
  ZIPFILE=$3
  console=/proc/$$/fd/$2
  # Write the location of the console buffer to /tmp/console for other scripts to use
  echo "$console" > /tmp/console
else
  console=$(cat /tmp/console)
  [ "$console" ] || console=/proc/$$/fd/1
fi

print ""
print "##################################################"
print "##                                              ##"
print "##  88      a8P         db        88        88  ##"
print "##  88    .88'         d88b       88        88  ##"
print "##  88   88'          d8''8b      88        88  ##"
print "##  88 d88           d8'  '8b     88        88  ##"
print "##  8888'88.        d8YaaaaY8b    88        88  ##"
print "##  88P   Y8b      d8''''''''8b   88        88  ##"
print "##  88     '88.   d8'        '8b  88        88  ##"
print "##  88       Y8b d8'          '8b 888888888 88  ##"
print "##                                              ##"
print "####  ############# NetHunter ####################"
print ""
print "* Uninstaller"
print ""

# Remove added firmware (folder would only exist if you installed Kali NetHunter)
[ -d "/system/etc/firmware/rtlwifi" ] && {
  print "* Removing firmware";
  rm -rf /system/etc/firmware/rtlwifi
  rm -rf /system/etc/firmware/zd1211
  rm -f  /system/etc/firmware/ar9170-1.fw
  rm -f  /system/etc/firmware/ar9170-2.fw
  rm -f  /system/etc/firmware/carl9170.fw
  rm -f  /system/etc/firmware/htc_7010.fw
  rm -f  /system/etc/firmware/rt73.bin
  rm -f  /system/etc/firmware/rt2561.bin
  rm -f  /system/etc/firmware/rt2860.bin
  rm -f  /system/etc/firmware/rt2870.bin
  rm -f  /system/etc/firmware/rt3070.bin
}

for x in data system_root; do
  print "* Mounting /${x}";
  mount /${x}

  [ "${x}" == "system_root" ] \
    && x="${x}/system"

  for y in app data; do
    remove_app "/${x}/${y}/com.offsec.nethunter"                  "NetHunter.apk" "${y}"
    remove_app "/${x}/${y}/com.offsec.nhterm"                     "NetHunterTerminal.apk" "${y}"
    remove_app "/${x}/${y}/com.offsec.nethunter.kex"              "NetHunterKeX.apk" "${y}"
    remove_app "/${x}/${y}/com.offsec.nethunter.store"            "NetHunterStore.apk" "${y}"
    remove_app "/${x}/${y}/com.offsec.nethunter.store.privileged" "NetHunterStorePrivilegedExtension.apk" "${y}"
  done
done

for x in system system_root/system; do
  remove_app "/${x}/priv-app/com.offsec.nethunter.store.privileged" "NetHunterStorePrivilegedExtension.apk" "${x}"
done

print "* Cleaning up"
cleanup

print "* Uninstall complete"
