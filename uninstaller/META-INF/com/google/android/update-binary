#!/sbin/sh
## Kali NetHunter uninstaller
## TODO:
## - Bootanimation
## - Wallpaper

print() {
  echo "${1:- }" \
    | while read -r line; do
       echo -e "ui_print $line" > "$console"
       echo -e "ui_print \n" > "$console"
    done
}

abort() {
  [ "$1" ] && {
    print "! Error: $1"
    print "* Aborting"
  }
  cleanup
  print "* Failed to uninstall Kali NetHunter!"
  exit 1
}

cleanup() {
  rm /system/.rw
  rm /data/.rw

  umount /system

  [ "$ZIPFILE" ] && {
   rm /tmp/console
  }
}

mount() {
  mountpoint -q "$1" || /sbin/busybox mount -o rw "$1" || abort "Unable to mount $1 as rw!"
  >> "$1/.rw" && return || /sbin/busybox mount -o remount,rw "$1"
  >> "$1/.rw" && return || abort "Unable to write to $1!"
}

if [ "$3" ]; then
  ZIPFILE=$3
  console=/proc/$$/fd/$2
  # Write the location of the console buffer to /tmp/console for other scripts to use
  echo "$console" > /tmp/console
else
  console=$(cat /tmp/console)
  [ "$console" ] || console=/proc/$$/fd/1
fi

print ""
print "##################################################"
print "##                                              ##"
print "##  88      a8P         db        88        88  ##"
print "##  88    .88'         d88b       88        88  ##"
print "##  88   88'          d8''8b      88        88  ##"
print "##  88 d88           d8'  '8b     88        88  ##"
print "##  8888'88.        d8YaaaaY8b    88        88  ##"
print "##  88P   Y8b      d8''''''''8b   88        88  ##"
print "##  88     '88.   d8'        '8b  88        88  ##"
print "##  88       Y8b d8'          '8b 888888888 88  ##"
print "##                                              ##"
print "####  ############# NetHunter ####################"
print ""
print "* Uninstaller"
print ""

# Remove added firmware (folder would only exist if you installed Kali NetHunter)
[ -d "/system/etc/firmware/rtlwifi" ] && {
  print "* Removing firmware";
  rm -rf /system/etc/firmware/rtlwifi
  rm -rf /system/etc/firmware/zd1211
  rm -f  /system/etc/firmware/ar9170-1.fw
  rm -f  /system/etc/firmware/ar9170-2.fw
  rm -f  /system/etc/firmware/carl9170.fw
  rm -f  /system/etc/firmware/htc_7010.fw
  rm -f  /system/etc/firmware/rt73.bin
  rm -f  /system/etc/firmware/rt2561.bin
  rm -f  /system/etc/firmware/rt2860.bin
  rm -f  /system/etc/firmware/rt2870.bin
  rm -f  /system/etc/firmware/rt3070.bin
}

for x in data system; do
  print "* Mounting /${x}";
  mount /${x}

  [ -d "/${x}/app/com.offsec.nethunter" ] && {
    print "* Removing NetHunter.apk"
    rm -rf /${x}/app/com.offsec.nethunter
  }

  [ -d "/${x}/app/com.offsec.nhterm" ] && {
    print "* Removing NetHunterTerminal.apk"
    rm -rf /${x}/app/com.offsec.nhterm
  }

  [ -d "/${x}/app/com.offsec.nethunter.kex" ] && {
    print "* Removing NetHunterKeX.apk"
    rm -rf /${x}/app/com.offsec.nethunter.kex
  }

  [ -d "/${x}/app/com.offsec.nethunter.store" ] && {
    print "* Removing NetHunterStore.apk"
    rm -rf /${x}/app/com.offsec.nethunter.store
  }
done

[ -d "/system/priv-app/com.offsec.nethunter.store.privileged" ] && {
  print "* Removing NetHunterStorePrivilegedExtension.apk"
  rm -rf /system/priv-app/com.offsec.nethunter.store.privileged
}

[ -d "/data/data/com.offsec.nethunter" ] && {
  print "* Removing NetHunter chroot/rootfs data"
  rm -rf /data/data/com.offsec.nethunter
}

print "* Cleaning up"
cleanup

print "* Uninstall complete"
