#!/sbin/sh
## Kali NetHunter installer
##
## Detect bootmode
##   BOOTMODE=true  = Device has booted into system (NetHunter installed as Magisk module)
##   BOOTMODE=false = Device has booted into recovery (NetHunter installed through TWRP)
##
## Apps
##   NetHunter.apk
##     https://gitlab.com/kalilinux/nethunter/apps/kali-nethunter-app
##     https://store.nethunter.com/packages/com.offsec.nethunter/
##   NetHunterTerminal.apk
##     https://gitlab.com/kalilinux/nethunter/apps/kali-nethunter-term
##     https://store.nethunter.com/packages/com.offsec.nhterm/
##   NetHunterKeX.apk
##     https://gitlab.com/kalilinux/nethunter/apps/kali-nethunter-kex
##     https://store.nethunter.com/packages/com.offsec.nethunter.kex/
##   NetHunterStore.apk
##     https://gitlab.com/kalilinux/nethunter/apps/kali-nethunter-store-client
##     https://store.nethunter.com/packages/com.offsec.nethunter.store/
##   NetHunterStorePrivilegedExtension.apk
##     https://gitlab.com/kalilinux/nethunter/apps/kali-nethunter-store-privileged-extension
##     https://store.nethunter.com/packages/com.offsec.nethunter.store.privileged/

#------------------------------------------------------------------------------

# Magisk - echo
# TWRP   - ui_print
print() {
  if $BOOTMODE; then
    echo "${1}"
  else
    echo "${1:- }" \
      | while read -r line; do
         echo -e "ui_print $line" > "$console"
         echo -e "ui_print \n" > "$console"
      done
  fi
}

#------------------------------------------------------------------------------

#<REF: ./scripts/util_functions.sh>
[ -z $BOOTMODE ] && ps | grep zygote | grep -qv grep && BOOTMODE=true
[ -z $BOOTMODE ] && ps -A 2>/dev/null | grep zygote | grep -qv grep && BOOTMODE=true
[ -z $BOOTMODE ] && BOOTMODE=false
#<REF: /./scripts/util_functions.sh>

if [ "$3" ]; then
  ZIPFILE=$3
  console=/proc/$$/fd/$2
  # Write the location of the console buffer to /tmp/console for other scripts to use
  [ -d /tmp ] && echo "$console" > /tmp/console
else
  [ -f /tmp/console ] && console=$(cat /tmp/console)
  [ "$console" ] || console=/proc/$$/fd/1
fi

#------------------------------------------------------------------------------

print ""
print "################################################"
print "#                                              #"
print "#  88      a8P         db        88        88  #"
print "#  88    .88'         d88b       88        88  #"
print "#  88   88'          d8''8b      88        88  #"
print "#  88 d88           d8'  '8b     88        88  #"
print "#  8888'88.        d8YaaaaY8b    88        88  #"
print "#  88P   Y8b      d8''''''''8b   88        88  #"
print "#  88     '88.   d8'        '8b  88        88  #"
print "#  88       Y8b d8'          '8b 888888888 88  #"
print "#                                              #"
print "###  ############# NetHunter ###################"
print ""
print "* NetHunter (BOOTMODE: $BOOTMODE)"
print ""

#------------------------------------------------------------------------------

if $BOOTMODE; then
  #####################################################
  ## Install in Magisk                               ##
  ##   ./scripts/util_functions.sh: install_module() ##
  #####################################################
  set_perm() {
    chown $2:$3 $1 || return 1
    chmod $4 $1 || return 1
    CON=$5
    [ -z $CON ] && CON=u:object_r:system_file:s0
    chcon $CON $1 || return 1
  }

  set_perm_recursive() {
    find $1 -type d 2>/dev/null | while read dir; do
      set_perm $dir $2 $3 $4 $6
    done

    find $1 -type f -o -type l 2>/dev/null | while read file; do
      set_perm $file $2 $3 $5 $6
    done
  }

  ## grep_prop()
  [ -f /data/adb/magisk/util_functions.sh ] && source /data/adb/magisk/util_functions.sh

  TMPDIR=/dev/tmp

  MODDIRNAME=modules_update
  MODULEROOT=/data/adb/$MODDIRNAME
  MODID=$(grep_prop id $TMPDIR/module.prop)
  MODPATH=$MODULEROOT/$MODID

  ## Install NetHunter
  unzip -oj "$ZIPFILE" META-INF/com/google/android/update-magisk -d $MODPATH >&2
  # Default permissions
  set_perm_recursive $MODPATH 0 0 0755 0644
  ## Run magisk script (Load customization script)
  [ -f $MODPATH/update-magisk ] && source $MODPATH/update-magisk
else
  #####################################################
  ## Install in Recovery/TWRP                        ##
  #####################################################
  TMPDIR=/tmp/nethunter

  print "* Unpacking the installer"
  rm -rf "$TMPDIR"
  mkdir -p "$TMPDIR"
  # Unpack the installer (everything but "kalifs-*")
  unzip -o "$ZIPFILE" -d "$TMPDIR" -x "kalifs-*"
  #print "* Installer unpacked"

  [ -f $TMPDIR/META-INF/com/google/android/update-recovery ] && source $TMPDIR/META-INF/com/google/android/update-recovery
fi

print ""
print "################################################"
print "#       Kali NetHunter is now installed!       #"
print "################################################"
## This is a work around an Android permission issue
print "#   Please UPDATE the NetHunter app via the    #"
print "#  NetHunter Store before RUNNING it to finish #"
print "#            setting everything up!            #"
print "################################################"
print ""
